<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Converscore.AI - Revenue Intelligence Avan√ßado</title>
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- XLSX library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            color: #0f172a;
        }
        .sidebar { background: linear-gradient(160deg, #0f172a 0%, #1e1b4b 100%); }
        .sidebar-item:hover, .sidebar-item.active { background-color: rgba(255,255,255,0.05); border-left: 3px solid #3b82f6; color: #f8fafc; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.2s ease; background-color: #f8fafc; }
        .drop-zone.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .table-tab { border-bottom: 2px solid transparent; }
        .table-tab.active { border-bottom-color: #0ea5e9; color: #0ea5e9; font-weight: 600; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .toast-enter { animation: toast-in 0.3s ease-out forwards; }
        @keyframes toast-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* C√≠rculo de Progresso Moderno */
        .score-circle {
            background: conic-gradient(var(--score-color, #3b82f6) var(--score), #e2e8f0 0deg);
        }
        
        [contenteditable="true"]:hover {
            background-color: rgba(59, 130, 246, 0.05);
            outline: 1px dashed #93c5fd;
            border-radius: 4px;
            cursor: text;
        }
        [contenteditable="true"]:focus {
            background-color: #fff;
            outline: 2px solid #3b82f6;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-50 overflow-hidden text-slate-800">

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl">
            <div class="flex justify-center mb-6">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-2">Acesso Restrito</h2>
            <p class="text-center text-sm text-slate-500 mb-6">Insira suas credenciais para continuar.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Usu√°rio</label>
                    <input type="text" id="loginUser" class="w-full border border-slate-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Padr√£o: admin">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Senha</label>
                    <input type="password" id="loginPass" class="w-full border border-slate-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Padr√£o: admin" onkeypress="if(event.key === 'Enter') document.getElementById('loginBtn').click()">
                </div>
                <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2.5 font-bold transition-colors shadow-md shadow-blue-500/30 mt-2">
                    Entrar no Sistema
                </button>
                <p id="loginError" class="text-red-500 text-xs text-center font-medium hidden mt-2">Credenciais inv√°lidas.</p>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="appContainer" class="flex h-screen w-full overflow-hidden hidden relative">

    <!-- Sidebar -->
    <aside id="mainSidebar" class="w-64 sidebar text-slate-400 flex-col h-full shrink-0 hidden md:flex absolute md:relative z-50 shadow-xl top-0 left-0">
        <button id="closeSidebarBtn" class="md:hidden absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <div class="h-16 flex items-center px-6 border-b border-white/10">
            <div class="flex items-center gap-2 text-white font-bold text-lg tracking-wide">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                </div>
                Converscore.<span class="text-blue-400 font-normal">AI</span>
            </div>
        </div>
        <nav class="flex-1 py-4 flex flex-col gap-1 px-3">
            <p class="text-[10px] font-bold uppercase tracking-widest text-slate-600 px-3 mb-2 mt-4">Menu Principal</p>
            <button id="nav-mineracao" class="sidebar-item active text-slate-300 flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                Intelig√™ncia Comercial
            </button>
            <button id="nav-logs" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                Hist√≥rico de Extra√ß√µes
            </button>
            <button id="nav-config" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                Configura√ß√µes da IA
            </button>
        </nav>
        <div class="p-4 border-t border-white/10">
            <div class="flex items-center gap-3 mb-4">
                <div id="loggedUserAvatar" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs text-white font-bold">AD</div>
                <div class="text-xs">
                    <p id="loggedUserName" class="text-white font-medium">admin</p>
                    <p class="text-slate-500">Administrador</p>
                </div>
            </div>
            <button id="logoutBtn" class="w-full flex items-center justify-center gap-2 text-xs font-semibold text-red-400 hover:text-red-300 transition-colors py-2 rounded-lg hover:bg-red-500/10">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                Sair do Sistema
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-10 w-full">
            <div class="flex items-center gap-3">
                <button id="mobileMenuBtn" class="md:hidden text-slate-500 hover:text-slate-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <h2 id="pageTitle" class="text-lg font-semibold text-slate-800">Revenue Intelligence</h2>
            </div>
            <button id="exportBtn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Exportar resultado analisado
            </button>
        </header>

        <div id="toastArea" class="absolute top-20 right-6 z-50 flex flex-col gap-2"></div>

        <div id="page-mineracao" class="flex-1 overflow-y-auto p-6 block">
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-slate-100 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1 relative z-10">Leads Analisados</p>
                    <h3 class="text-2xl font-bold text-slate-800 relative z-10" id="statTotal">0</h3>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                    <p class="text-xs font-bold text-red-500 uppercase mb-1 relative z-10">Oportunidades Quentes</p>
                    <h3 class="text-2xl font-bold text-red-600 relative z-10" id="statQuente">0</h3>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-orange-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                    <p class="text-xs font-bold text-orange-500 uppercase mb-1 relative z-10">Radar (Mornos)</p>
                    <h3 class="text-2xl font-bold text-orange-600 relative z-10" id="statMorno">0</h3>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-slate-100 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1 relative z-10">Descartes & Sem Potencial</p>
                    <h3 class="text-2xl font-bold text-slate-600 relative z-10" id="statFrio">0</h3>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm mb-6">
                <div id="dropZone" class="drop-zone rounded-lg p-8 text-center cursor-pointer">
                    <input type="file" id="fileInput" class="hidden" accept=".csv" />
                    <div id="uploadPrompt">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3 border border-slate-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        </div>
                        <p class="text-base font-semibold text-slate-700">Arraste a base de hist√≥rico (CSV)</p>
                        <p class="text-slate-500 text-xs mt-1">O sistema fornecer√° Scoring e Diagn√≥stico Estrat√©gico Objetivo para cada lead.</p>
                    </div>

                    <div id="fileInfo" class="hidden">
                        <div class="inline-flex items-center gap-2 bg-blue-50 text-blue-700 px-4 py-2 rounded-md border border-blue-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd"/></svg>
                            <span id="fileName" class="text-sm font-semibold"></span>
                        </div>
                        <button id="removeFileBtn" class="block mx-auto mt-3 text-xs text-red-500 hover:text-red-700 font-medium transition-colors">Remover Arquivo</button>
                    </div>
                </div>

                <div id="progressArea" class="hidden mt-6">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <p class="text-xs font-bold text-slate-800 uppercase tracking-wider">Processando Intelig√™ncia de Vendas</p>
                            <p class="text-[10px] text-slate-500" id="progressSubtitle">Mapeando problemas, impactos e gerando scores em tempo real...</p>
                        </div>
                        <span id="progressPercent" class="text-sm font-bold text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                        <div id="progressBar" class="bg-blue-500 h-full rounded-full transition-all duration-300 w-0"></div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <button id="clearDataBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2.5 rounded-lg text-sm font-semibold transition-colors hidden">
                        Limpar Tabela
                    </button>
                    <button id="processBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-semibold shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        Iniciar Qualifica√ß√£o Executiva
                    </button>
                </div>
            </div>

            <div id="resultsContainer" class="hidden bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col min-h-[400px]">
                <div class="flex border-b border-slate-200 px-2 pt-2 bg-slate-50/50 rounded-t-xl overflow-x-auto justify-between items-center pr-4">
                    <div class="flex">
                        <button id="tabQualified" class="table-tab active whitespace-nowrap px-5 py-3 text-sm font-medium text-slate-500 hover:text-slate-800 transition-colors">
                            Oportunidades (Score & Timing)
                        </button>
                        <button id="tabDiscarded" class="table-tab whitespace-nowrap px-5 py-3 text-sm font-medium text-slate-500 hover:text-slate-800 transition-colors">
                            Descartes Claros
                        </button>
                    </div>
                    <span class="text-xs text-slate-400 font-medium italic">Clique nos textos da tabela para edit√°-los antes de exportar.</span>
                </div>

                <div id="viewQualified" class="overflow-x-auto p-0">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-600 border-b border-slate-200 text-xs font-semibold">
                            <tr>
                                <th class="py-3 px-5 w-[20%]">Lead & Empresa</th>
                                <th class="py-3 px-5 w-[40%]">An√°lise & Evid√™ncia</th>
                                <th class="py-3 px-5 w-[20%]">Score & Timing</th>
                                <th class="py-3 px-5 w-[20%]">A√ß√£o Recomendada</th>
                            </tr>
                        </thead>
                        <tbody id="qualifiedTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>

                <div id="viewDiscarded" class="hidden overflow-x-auto p-0">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-600 border-b border-slate-200 text-xs font-semibold">
                            <tr>
                                <th class="py-3 px-5 w-[25%]">Lead & Empresa</th>
                                <th class="py-3 px-5">Motivo T√©cnico de Descarte</th>
                            </tr>
                        </thead>
                        <tbody id="discardedTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAGE: Logs -->
        <div id="page-logs" class="hidden flex-1 overflow-y-auto p-6">
            <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm min-h-[400px]">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 mb-1">Hist√≥rico de Arquivos Processados</h3>
                        <p class="text-sm text-slate-500">Registro das an√°lises realizadas nesta sess√£o.</p>
                    </div>
                </div>
                <div id="logsContent">
                    <div class="text-center py-12" id="emptyLogsState">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-slate-300 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <p class="text-slate-500 font-medium">Nenhum log anterior encontrado.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: Config -->
        <div id="page-config" class="hidden flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                
                <!-- Contexto de Vendas (Modo Edi√ß√£o e Leitura) -->
                <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Contexto do Seu Produto (IA)</h3>
                    <p class="text-sm text-slate-500 mb-4">Ensine a IA sobre o que voc√™ vende para gerar pr√≥ximos passos e an√°lises alinhadas com sua solu√ß√£o.</p>

                    <!-- MODO EDI√á√ÉO -->
                    <div id="contextEditMode" class="space-y-4 mb-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">O que sua empresa vende? (Proposta de Valor)</label>
                            <textarea id="inputProductContext" rows="2" placeholder="Ex: Software de gest√£o financeira focado em controle de SLAs." class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Principais Concorrentes / Ferramentas Anteriores</label>
                            <textarea id="inputCompetitorContext" rows="2" placeholder="Ex: Planilhas, GLPI, Trello." class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Principais Dores Resolvidas</label>
                            <textarea id="inputPainContext" rows="2" placeholder="Ex: Perda de prazos, falta de visibilidade, custo alto." class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="flex items-center gap-3 pt-2">
                            <button id="saveContextBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-semibold transition-colors">
                                Salvar Contexto da IA
                            </button>
                        </div>
                    </div>

                    <!-- MODO LEITURA (Vis√£o do que foi salvo) -->
                    <div id="contextViewMode" class="hidden space-y-3 mb-2">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <strong class="block text-[10px] text-blue-600 uppercase tracking-wider mb-1">Proposta de Valor</strong>
                            <p id="viewProductContext" class="text-sm text-slate-800 leading-relaxed"></p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <strong class="block text-[10px] text-blue-600 uppercase tracking-wider mb-1">Concorrentes</strong>
                            <p id="viewCompetitorContext" class="text-sm text-slate-800 leading-relaxed"></p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <strong class="block text-[10px] text-blue-600 uppercase tracking-wider mb-1">Dores que Resolve</strong>
                            <p id="viewPainContext" class="text-sm text-slate-800 leading-relaxed"></p>
                        </div>
                        <div class="flex justify-end pt-2">
                            <button id="editContextBtn" class="text-slate-600 hover:text-slate-900 text-sm font-semibold flex items-center gap-1.5 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                Editar Contexto
                            </button>
                        </div>
                    </div>

                </div>

                <div class="flex flex-col gap-6">
                    <!-- Configura√ß√£o da Chave de API -->
                    <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-slate-800 mb-2">Credenciais da API</h3>
                        <p class="text-sm text-slate-500 mb-4">Insira sua chave do Google Gemini para funcionar no GitHub Pages.</p>
                        <div class="flex flex-col gap-3">
                            <input type="password" id="inputApiKey" placeholder="Cole sua chave AIzaSy..." class="border border-slate-300 rounded-md px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                            <button id="saveApiKeyBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-md text-sm transition-colors mt-1">
                                Salvar Chave
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-lg font-semibold text-slate-800 mb-2">Motor Cognitivo</h3>
                        <p class="text-sm text-slate-500 mb-6">Inje√ß√£o nativa de API ativa. Gerenciamento de acessos abaixo.</p>

                        <div class="flex flex-col gap-3 mb-6 bg-slate-50 p-4 rounded-lg border border-slate-100">
                            <input type="text" id="newUsername" placeholder="Novo Usu√°rio" class="border border-slate-300 rounded-md px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                            <input type="password" id="newPassword" placeholder="Nova Senha" class="border border-slate-300 rounded-md px-3 py-2 text-sm outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                            <button id="addUserBtn" class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2 rounded-md text-sm transition-colors mt-1">
                                Adicionar Usu√°rio
                            </button>
                        </div>

                        <h4 class="text-sm font-bold text-slate-700 mb-3">Contas Ativas</h4>
                        <div id="usersList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    </div>

    <script>
        (() => {
            'use strict';

            const apiKey = ""; 

            const CONFIG = Object.freeze({
                STORAGE_KEY_API: 'revops_api_key',
                STORAGE_KEY_LOGS: 'revops_processing_history',
                STORAGE_KEY_DATA: 'revops_saved_table_data',
                STORAGE_KEY_PROD: 'revops_context_product',
                STORAGE_KEY_COMP: 'revops_context_competitors',
                STORAGE_KEY_PAIN: 'revops_context_pain',
                DEFAULT_MODEL: 'gemini-2.5-flash-preview-09-2025',
                MAX_RETRIES: 5,
                MAX_RATE_LIMIT_RETRIES: 50,
                BASE_DELAY_MS: 3000, 
                RATE_LIMIT_FALLBACK_DELAY_MS: 60000,
                CONCURRENCY: 3, 
                BATCH_SIZE: 5
            });

            const $ = (id) => document.getElementById(id);

            const dom = Object.freeze({
                loginScreen: $('loginScreen'),
                appContainer: $('appContainer'),
                loginUser: $('loginUser'),
                loginPass: $('loginPass'),
                loginBtn: $('loginBtn'),
                loginError: $('loginError'),

                navMineracao: $('nav-mineracao'),
                navLogs: $('nav-logs'),
                navConfig: $('nav-config'),

                pageTitle: $('pageTitle'),
                logoutBtn: $('logoutBtn'),
                loggedUserName: $('loggedUserName'),
                loggedUserAvatar: $('loggedUserAvatar'),

                toastArea: $('toastArea'),

                mobileMenuBtn: $('mobileMenuBtn'),
                mainSidebar: $('mainSidebar'),
                closeSidebarBtn: $('closeSidebarBtn'),

                dropZone: $('dropZone'),
                fileInput: $('fileInput'),
                uploadPrompt: $('uploadPrompt'),
                fileInfo: $('fileInfo'),
                fileName: $('fileName'),
                removeFileBtn: $('removeFileBtn'),

                progressArea: $('progressArea'),
                progressSubtitle: $('progressSubtitle'),
                progressPercent: $('progressPercent'),
                progressBar: $('progressBar'),

                processBtn: $('processBtn'),
                clearDataBtn: $('clearDataBtn'),
                exportBtn: $('exportBtn'),

                statTotal: $('statTotal'),
                statQuente: $('statQuente'),
                statMorno: $('statMorno'),
                statFrio: $('statFrio'),

                resultsContainer: $('resultsContainer'),
                tabQualified: $('tabQualified'),
                tabDiscarded: $('tabDiscarded'),
                viewQualified: $('viewQualified'),
                viewDiscarded: $('viewDiscarded'),
                qualifiedTableBody: $('qualifiedTableBody'),
                discardedTableBody: $('discardedTableBody'),

                pageMineracao: $('page-mineracao'),
                pageLogs: $('page-logs'),
                pageConfig: $('page-config'),
                logsContent: $('logsContent'),
                emptyLogsState: $('emptyLogsState'),

                newUsername: $('newUsername'),
                newPassword: $('newPassword'),
                addUserBtn: $('addUserBtn'),
                usersList: $('usersList'),
                
                inputProductContext: $('inputProductContext'),
                inputCompetitorContext: $('inputCompetitorContext'),
                inputPainContext: $('inputPainContext'),
                saveContextBtn: $('saveContextBtn'),
                
                contextEditMode: $('contextEditMode'),
                contextViewMode: $('contextViewMode'),
                viewProductContext: $('viewProductContext'),
                viewCompetitorContext: $('viewCompetitorContext'),
                viewPainContext: $('viewPainContext'),
                editContextBtn: $('editContextBtn'),
                
                inputApiKey: $('inputApiKey'),
                saveApiKeyBtn: $('saveApiKeyBtn')
            });

            const Toast = (() => {
                function iconFor(type) {
                    if (type === 'success') {
                        return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                    }
                    if (type === 'info') {
                        return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
                    }
                    return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
                }

                function bgFor(type) {
                    if (type === 'error') return 'bg-red-600';
                    if (type === 'success') return 'bg-emerald-600';
                    if (type === 'info') return 'bg-amber-500';
                    return 'bg-blue-600';
                }

                function show(message, type = 'error') {
                    const toast = document.createElement('div');
                    toast.className = `${bgFor(type)} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 text-sm font-semibold toast-enter`;
                    toast.innerHTML = `${iconFor(type)} <span></span>`;
                    toast.querySelector('span').textContent = message;

                    dom.toastArea.appendChild(toast);

                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateY(-10px)';
                        toast.style.transition = 'all 0.3s ease';
                        setTimeout(() => toast.remove(), 300);
                    }, 5000);
                }

                return { show };
            })();

            const Storage = (() => {
                function get(key, fallback) {
                    try {
                        const raw = localStorage.getItem(key);
                        if (!raw) return fallback;
                        return JSON.parse(raw);
                    } catch {
                        return fallback;
                    }
                }

                function set(key, value) {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                        return true;
                    } catch {
                        return false;
                    }
                }

                function getText(key, fallback = '') {
                    try {
                        return localStorage.getItem(key) || fallback;
                    } catch {
                        return fallback;
                    }
                }

                function setText(key, value) {
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch {
                        return false;
                    }
                }

                return { get, set, getText, setText };
            })();

            const CSV = (() => {
                function detectSeparator(headerLine) {
                    const commas = (headerLine.match(/,/g) || []).length;
                    const semis = (headerLine.match(/;/g) || []).length;
                    return semis > commas ? ';' : ',';
                }

                function parse(text) {
                    const trimmed = (text || '').trim();
                    if (!trimmed) return [];

                    const lines = [];
                    let current = '';
                    let inQuotes = false;

                    for (let i = 0; i < trimmed.length; i++) {
                        const ch = trimmed[i];
                        const next = trimmed[i + 1];

                        if (ch === '"') {
                            if (inQuotes && next === '"') {
                                current += '"';
                                i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                            continue;
                        }

                        if (!inQuotes && (ch === '\n' || ch === '\r')) {
                            if (ch === '\r' && next === '\n') i++;
                            lines.push(current);
                            current = '';
                            continue;
                        }

                        current += ch;
                    }
                    if (current) lines.push(current);

                    if (lines.length < 2) return [];

                    const sep = detectSeparator(lines[0]);

                    const headers = splitLine(lines[0], sep).map(h => h.trim());
                    const rows = [];

                    for (let i = 1; i < lines.length; i++) {
                        const parts = splitLine(lines[i], sep);
                        if (!parts.some(v => (v || '').trim() !== '')) continue;

                        const obj = {};
                        for (let c = 0; c < headers.length; c++) {
                            obj[headers[c]] = (parts[c] ?? '').trim();
                        }
                        rows.push(obj);
                    }

                    return rows;
                }

                function splitLine(line, sep) {
                    const out = [];
                    let cur = '';
                    let inQuotes = false;

                    for (let i = 0; i < line.length; i++) {
                        const ch = line[i];
                        const next = line[i + 1];

                        if (ch === '"') {
                            if (inQuotes && next === '"') {
                                cur += '"';
                                i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                            continue;
                        }

                        if (!inQuotes && ch === sep) {
                            out.push(cur);
                            cur = '';
                            continue;
                        }

                        cur += ch;
                    }
                    out.push(cur);
                    return out;
                }

                return { parse };
            })();

            const Concurrency = (() => {
                async function pool(items, limit, worker, onProgress) {
                    const results = new Array(items.length);
                    let index = 0;
                    let done = 0;

                    async function runner() {
                        while (index < items.length) {
                            const currentIndex = index++;
                            results[currentIndex] = await worker(items[currentIndex], currentIndex);
                            done++;
                            if (onProgress) onProgress(done, items.length);
                        }
                    }

                    const runners = [];
                    for (let i = 0; i < Math.min(limit, items.length); i++) runners.push(runner());
                    await Promise.all(runners);
                    return results;
                }

                return { pool };
            })();

            const Gemini = (() => {
                function buildPrompt() {
                    const prod = Storage.getText(CONFIG.STORAGE_KEY_PROD, '');
                    const comp = Storage.getText(CONFIG.STORAGE_KEY_COMP, '');
                    const pain = Storage.getText(CONFIG.STORAGE_KEY_PAIN, '');
                    let contextStr = '';
                    
                    if (prod || comp || pain) {
                        contextStr = `\nCONTEXTO DO SEU NEG√ìCIO:\nProduto/Servi√ßo: ${prod || 'N√£o especificado'}\nConcorrentes mapeados: ${comp || 'N√£o especificado'}\nDores que voc√™ resolve: ${pain || 'N√£o especificado'}\n`;
                    }

                    return `Voc√™ √© um Analista Estrat√©gico S√™nior avaliando leads B2B. Aja com precis√£o cir√∫rgica.

DIRETRIZ M√ÅXIMA DE IDIOMA:
Gere todas as respostas EXCLUSIVAMENTE em Portugu√™s do Brasil (PT-BR).

REGRAS DE CLASSIFICA√á√ÉO EM 5 N√çVEIS (APLIQUE NESTA ORDEM DE PRIORIDADE):

1. LIXO E ROB√îS = DESCARTADO:
   Mensagens autom√°ticas puras ("aus√™ncia", "fora do escrit√≥rio") sem indicar um substituto, OU APENAS sinais de pontua√ß√£o ("?", "."). -> "üö´ Descartado" (Score 0 a 9).
   
2. NEGATIVA CLARA = DESCARTADO:
   "N√£o tenho interesse", "J√° somos clientes", "Pare de mandar". -> "üö´ Descartado" (Score 0 a 9).

3. DOR, ESCOPO OU INDICA√á√ÉO = QUENTE:
   Confirmou dor ("precisamos melhorar", "√© um desafio"), dimensionou escopo ("somos 20"), ou informou que foi "indica√ß√£o". -> "üî• Quente" (Score 80 a 100).

4. PRAZOS FUTUROS E INTERESSE REAL = MORNO:
   Pediu retorno futuro ("f√©rias", "m√™s que vem", "setembro"), pediu envio de material para an√°lise, ou fez perguntas sobre a solu√ß√£o indicando interesse em evoluir. -> "üå§ Morno" (Score 60 a 79).

5. USO DE CONCORRENTE / OBJE√á√ÉO SEM INTERESSE = FRIO COM POTENCIAL:
   Informou que J√Å POSSUI sistema ("j√° usamos Jira", "nossa ferramenta atende") MAS N√ÉO demonstrou interesse em mudar. Existe a brecha tecnol√≥gica, mas o lead n√£o est√° ativamente interessado. -> "‚ùÑ Frio com Potencial" (Score 30 a 59).

6. INTERA√á√ÉO VAZIA (SAUDA√á√ïES/ORIGEM) = INTERA√á√ÉO SEM POTENCIAL CLARO:
   O lead humano APENAS saudou ou perguntou a origem ("oi", "tudo bem?", "quem √©?", "como conseguiu meu n√∫mero?", "sim" isolado) e N√ÉO ENTROU NO M√âRITO do neg√≥cio. -> "üßä Intera√ß√£o sem Potencial Claro" (Score 10 a 29).

CAMPOS DE SA√çDA OBRIGAT√ìRIOS:
- Temperatura: Use EXATAMENTE uma das 5 tags permitidas no schema.
- Motivo_Classificacao: Explique a escolha diretamente baseado na regra acima.
- Evidencia_Conversa: TRANSCREVA LITERALMENTE do [IN] o trecho que prova a decis√£o. Se for rob√¥, escreva "Mensagem autom√°tica". Ignore sauda√ß√µes soltas.
- Timing_Identificado: O m√™s/data mencionado. Sen√£o, "N√£o definido".
- Acao_Recomendada: A a√ß√£o pr√°tica sugerida.
${contextStr}`;
                }

                function buildSchema() {
                    return {
                        type: "OBJECT",
                        properties: {
                            leads: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        Temperatura: { 
                                            type: "STRING",
                                            enum: [
                                                "üî• Quente", 
                                                "üå§ Morno", 
                                                "‚ùÑ Frio com Potencial", 
                                                "üßä Intera√ß√£o sem Potencial Claro", 
                                                "üö´ Descartado"
                                            ] 
                                        },
                                        Motivo_Classificacao: { type: "STRING" },
                                        Evidencia_Conversa: { type: "STRING" },
                                        Timing_Identificado: { type: "STRING" },
                                        Acao_Recomendada: { type: "STRING" },
                                        Score_Potencial: { type: "NUMBER" },
                                        Nome: { type: "STRING" },
                                        Empresa: { type: "STRING" }
                                    }
                                }
                            }
                        }
                    };
                }

                function buildFallback(batch, e) {
                    const errStatus = e.status || 500;
                    const is400 = errStatus === 400;
                    
                    const fallbackLeads = batch.map(b => ({
                        Lead_ID: b.lead_id,
                        Temperatura: 'üö´ Descartado',
                        Motivo_Classificacao: is400 ? 'Erro 400: API Key ausente ou inv√°lida. Insira a chave no c√≥digo.' : 'Erro na comunica√ß√£o com a API.',
                        Evidencia_Conversa: '-',
                        Timing_Identificado: '-',
                        Acao_Recomendada: 'Revisar manualmente.',
                        Score_Potencial: 0,
                        Nome: b.nome,
                        Empresa: b.empresa
                    }));
                    return { leads: fallbackLeads };
                }

                function isRateLimitError(err) {
                    if (!err) return false;
                    const msg = (err.message || '').toLowerCase();
                    return err.status === 429 || msg.includes('quota') || msg.includes('429') || msg.includes('rate');
                }

                function parseRetrySeconds(message) {
                    const m = (message || '').match(/retry in (\d+\.?\d*)s/i);
                    if (!m || !m[1]) return null;
                    const sec = Number(m[1]);
                    return Number.isFinite(sec) ? sec : null;
                }

                async function call(batch, modelName = CONFIG.DEFAULT_MODEL) {
                    const activeKey = Storage.getText(CONFIG.STORAGE_KEY_API, '').trim() || apiKey;

                    const payload = {
                        contents: [{ parts: [{ text: JSON.stringify(batch) }] }],
                        systemInstruction: { parts: [{ text: buildPrompt() }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: buildSchema()
                        }
                    };

                    let retries = CONFIG.MAX_RETRIES;
                    let rateLimitRetries = CONFIG.MAX_RATE_LIMIT_RETRIES;
                    let delay = CONFIG.BASE_DELAY_MS;

                    while (true) {
                        try {
                            const res = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${activeKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                }
                            );

                            const data = await res.json().catch(() => ({}));
                            if (!res.ok) {
                                const err = new Error(data?.error?.message || `HTTP ${res.status}`);
                                err.status = res.status;
                                throw err;
                            }

                            const responseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (!responseText) throw new Error('Resposta da API vazia');

                            let cleanText = responseText.replace(/^```json/im, '').replace(/```$/m, '').trim();
                            const parsed = JSON.parse(cleanText);
                            
                            if (!parsed || !Array.isArray(parsed.leads)) parsed.leads = [];

                            for (let i = 0; i < batch.length; i++) {
                                const original = batch[i];
                                const out = parsed.leads[i] || {};
                                parsed.leads[i] = {
                                    Lead_ID: original.lead_id,
                                    Temperatura: out.Temperatura || 'üö´ Descartado',
                                    Motivo_Classificacao: out.Motivo_Classificacao || 'Sem justificativa.',
                                    Evidencia_Conversa: out.Evidencia_Conversa || 'Nenhuma evid√™ncia.',
                                    Timing_Identificado: out.Timing_Identificado || 'N√£o definido',
                                    Acao_Recomendada: out.Acao_Recomendada || '-',
                                    Score_Potencial: out.Score_Potencial || 0,
                                    Nome: (out.Nome && out.Nome !== 'N/A') ? out.Nome : original.nome,
                                    Empresa: (out.Empresa && out.Empresa !== 'N/A') ? out.Empresa : original.empresa
                                };
                            }

                            return parsed;

                        } catch (e) {
                            if (e.status === 400) {
                                console.error("Erro 400 na API do Gemini. Verifique a API Key.", e);
                                return buildFallback(batch, e);
                            }

                            if (isRateLimitError(e)) {
                                rateLimitRetries--;
                                if (rateLimitRetries <= 0) return buildFallback(batch, e);

                                const sec = parseRetrySeconds(e.message);
                                const waitMs = sec ? (sec * 1000 + 2000) : CONFIG.RATE_LIMIT_FALLBACK_DELAY_MS;
                                
                                const currentSubtitle = dom.progressSubtitle.textContent;
                                dom.progressSubtitle.textContent = `Aguardando libera√ß√£o de cota do Google (${Math.round(waitMs / 1000)}s)...`;
                                
                                await new Promise(r => setTimeout(r, waitMs));
                                
                                dom.progressSubtitle.textContent = currentSubtitle;
                                continue;
                            }

                            retries--;
                            if (retries <= 0) {
                                return buildFallback(batch, e);
                            }
                            await new Promise(r => setTimeout(r, delay));
                            delay *= 2;
                        }
                    }
                }

                return { call };
            })();

            const State = {
                selectedFile: null,
                currentUser: null,
                users: [{ user: 'admin', pass: 'admin' }],
                data: { leads: Storage.get(CONFIG.STORAGE_KEY_DATA, []) },
                history: Storage.get(CONFIG.STORAGE_KEY_LOGS, []),
                isProcessing: false,
                totalProcessingLength: 0
            };

            const UI = (() => {
                function setVisible(el, visible) {
                    el.classList.toggle('hidden', !visible);
                }

                function setActiveNav(target) {
                    [dom.navMineracao, dom.navLogs, dom.navConfig].forEach(b => b.classList.remove('active', 'text-slate-300'));
                    target.classList.add('active', 'text-slate-300');
                }

                function switchPage(page) {
                    setVisible(dom.pageMineracao, page === 'mineracao');
                    setVisible(dom.pageLogs, page === 'logs');
                    setVisible(dom.pageConfig, page === 'config');

                    const titles = {
                        mineracao: 'Revenue Intelligence & Minera√ß√£o',
                        logs: 'Hist√≥rico de Extra√ß√µes',
                        config: 'Configura√ß√µes da IA'
                    };
                    dom.pageTitle.textContent = titles[page] || 'Revenue Intelligence';

                    const hasLeads = State.data.leads && State.data.leads.length > 0;
                    setVisible(dom.exportBtn, page === 'mineracao' && hasLeads);
                    setVisible(dom.resultsContainer, page === 'mineracao' && hasLeads);
                    setVisible(dom.clearDataBtn, page === 'mineracao' && hasLeads);

                    if (page === 'logs') renderLogs();
                    if (page === 'config') renderContextView();
                }

                function updateStats() {
                    const leads = State.data.leads || [];
                    const q = leads.filter(l => (l.Temperatura || '').includes('Quente')).length;
                    const m = leads.filter(l => (l.Temperatura || '').includes('Morno') || (l.Temperatura || '').includes('Frio com Potencial')).length;
                    const f = leads.filter(l => (l.Temperatura || '').includes('Descartado') || (l.Temperatura || '').includes('Intera√ß√£o')).length;

                    dom.statTotal.textContent = State.totalProcessingLength > 0 ? `${leads.length} / ${State.totalProcessingLength}` : leads.length;
                    dom.statQuente.textContent = String(q);
                    dom.statMorno.textContent = String(m);
                    dom.statFrio.textContent = String(f);
                }

                function resetUpload() {
                    State.selectedFile = null;
                    dom.fileInput.value = '';
                    setVisible(dom.uploadPrompt, true);
                    setVisible(dom.fileInfo, false);
                    setVisible(dom.progressArea, false);
                }
                
                function clearAllData() {
                    if (State.isProcessing) {
                        return Toast.show("Aguarde a an√°lise finalizar antes de limpar a tabela.", "info");
                    }
                    
                    State.data.leads = [];
                    State.totalProcessingLength = 0;
                    Storage.set(CONFIG.STORAGE_KEY_DATA, []);
                    updateStats();
                    
                    dom.qualifiedTableBody.innerHTML = '';
                    dom.discardedTableBody.innerHTML = '';
                    
                    resetUpload();
                    setVisible(dom.resultsContainer, false);
                    setVisible(dom.exportBtn, false);
                    setVisible(dom.clearDataBtn, false);
                    
                    Toast.show("Tabela de dados limpa.", "success");
                }

                function setProgress(percent, subtitle) {
                    const p = Math.max(0, Math.min(100, percent));
                    dom.progressBar.style.width = `${p}%`;
                    dom.progressPercent.textContent = `${p}%`;
                    if (subtitle) dom.progressSubtitle.textContent = subtitle;
                }

                function escapeText(v) {
                    return (v ?? '').toString();
                }

                function handleEdit(event, index, field) {
                    const newValue = event.target.innerText;
                    if(State.data.leads[index]) {
                        State.data.leads[index][field] = newValue;
                        Storage.set(CONFIG.STORAGE_KEY_DATA, State.data.leads);
                    }
                }
                
                function createEditableCell(text, index, field, extraClasses = '') {
                    return `<span contenteditable="true" onblur="window.updateLeadData(event, ${index}, '${field}')" class="block p-1 -m-1 ${extraClasses}">${escapeText(text)}</span>`;
                }

                function renderTables() {
                    const leads = State.data.leads || [];
                    const qualified = leads.filter(l => !(l.Temperatura || '').includes('Descartado'));
                    const discarded = leads.filter(l => (l.Temperatura || '').includes('Descartado'));

                    renderQualified(qualified);
                    renderDiscarded(discarded);
                    setVisible(dom.resultsContainer, leads.length > 0);
                    setVisible(dom.exportBtn, leads.length > 0);
                    setVisible(dom.clearDataBtn, leads.length > 0);
                }

                function renderQualified(list) {
                    dom.qualifiedTableBody.innerHTML = '';
                    const leadsOriginal = State.data.leads;

                    list.forEach(lead => {
                        const originalIndex = leadsOriginal.indexOf(lead);
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-200';

                        const tempStr = lead.Temperatura || '';
                        let badgeClass = 'bg-slate-100 text-slate-700';
                        let scoreColorHex = '#94a3b8';
                        let scoreTextClass = 'text-slate-900';
                        let scoreBgClass = 'bg-slate-50';

                        if (tempStr.includes('Quente')) {
                            badgeClass = 'bg-red-100 text-red-700';
                            scoreColorHex = '#ef4444';
                            scoreTextClass = 'text-red-900';
                            scoreBgClass = 'bg-red-50';
                        } else if (tempStr.includes('Morno')) {
                            badgeClass = 'bg-orange-100 text-orange-700';
                            scoreColorHex = '#f97316';
                            scoreTextClass = 'text-orange-900';
                            scoreBgClass = 'bg-orange-50';
                        } else if (tempStr.includes('Frio com Potencial')) {
                            badgeClass = 'bg-blue-100 text-indigo-700';
                            scoreColorHex = '#6366f1';
                            scoreTextClass = 'text-indigo-900';
                            scoreBgClass = 'bg-indigo-50';
                        } else if (tempStr.includes('Intera√ß√£o')) {
                            badgeClass = 'bg-slate-200 text-slate-600';
                            scoreColorHex = '#94a3b8';
                            scoreTextClass = 'text-slate-700';
                            scoreBgClass = 'bg-slate-100';
                        }
                        
                        const scoreNum = Number(lead.Score_Potencial) || 0;

                        tr.innerHTML = `
                            <td class="py-4 px-5 align-top">
                                <div class="mb-3">
                                    <div class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${badgeClass} mb-1.5">
                                        ${escapeText(lead.Temperatura)}
                                    </div>
                                    <div class="text-[11px] text-slate-500 italic leading-snug border-l-2 border-slate-200 pl-2 py-0.5">
                                        ${createEditableCell(lead.Motivo_Classificacao, originalIndex, 'Motivo_Classificacao')}
                                    </div>
                                </div>
                                <div class="font-bold text-slate-800 text-sm">${createEditableCell(lead.Nome, originalIndex, 'Nome')}</div>
                                <div class="text-xs text-slate-500">${createEditableCell(lead.Empresa, originalIndex, 'Empresa')}</div>
                                <div class="mt-2 text-[10px] text-slate-400 flex flex-col gap-0.5">
                                    ${lead.telefone ? `<span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>${createEditableCell(lead.telefone, originalIndex, 'telefone')}</span>` : ''}
                                    ${lead.email ? `<span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>${createEditableCell(lead.email, originalIndex, 'email')}</span>` : ''}
                                </div>
                            </td>
                            <td class="py-4 px-5 align-top">
                                <div class="text-sm text-slate-700 leading-relaxed bg-white border border-slate-200 p-3 rounded-lg shadow-sm">
                                    <strong class="font-semibold text-slate-900 block text-[10px] uppercase tracking-wider mb-1">Evid√™ncia Extra√≠da:</strong>
                                    <span class="italic text-slate-700 font-medium">"${createEditableCell(lead.Evidencia_Conversa, originalIndex, 'Evidencia_Conversa')}"</span>
                                </div>
                            </td>
                            <td class="py-4 px-5 align-top text-sm">
                                <div class="flex items-center gap-3 ${scoreBgClass} p-2.5 rounded-lg border border-slate-200 shadow-sm mb-3">
                                    <div class="relative w-10 h-10 flex items-center justify-center rounded-full score-circle shrink-0" style="--score: ${scoreNum}%; --score-color: ${scoreColorHex};">
                                        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center font-black ${scoreTextClass} text-xs shadow-inner">${scoreNum}</div>
                                    </div>
                                    <div>
                                        <strong class="font-bold ${scoreTextClass} text-xs block uppercase tracking-wider">Score Global</strong>
                                        <span class="text-[9px] ${scoreTextClass} opacity-80 uppercase font-medium tracking-wide">Alinhamento IA</span>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs">
                                    <strong class="text-slate-800 block mb-1">Timing / Retorno:</strong> 
                                    <span class="text-blue-700 font-bold bg-white px-2 py-1.5 rounded border border-blue-100 text-xs inline-block shadow-sm">
                                        ${createEditableCell(lead.Timing_Identificado, originalIndex, 'Timing_Identificado')}
                                    </span>
                                </div>
                            </td>
                            <td class="py-4 px-5 align-top text-sm">
                                <div class="text-[11px] text-slate-600 bg-white border border-slate-200 p-2.5 rounded-lg shadow-sm leading-relaxed">
                                    <strong class="text-slate-800 block mb-1 font-semibold uppercase tracking-wider text-[10px]">A√ß√£o Estrat√©gica</strong>
                                    ${createEditableCell(lead.Acao_Recomendada, originalIndex, 'Acao_Recomendada')}
                                </div>
                            </td>
                        `;
                        dom.qualifiedTableBody.appendChild(tr);
                    });
                }

                function renderDiscarded(list) {
                    dom.discardedTableBody.innerHTML = '';
                    const leadsOriginal = State.data.leads;

                    list.forEach(lead => {
                        const originalIndex = leadsOriginal.indexOf(lead);
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-200';

                        tr.innerHTML = `
                            <td class="py-4 px-5 align-top">
                                <div class="mb-3">
                                    <div class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-slate-200 text-slate-600 mb-1.5">
                                        ${escapeText(lead.Temperatura || 'üö´ Descartado')}
                                    </div>
                                    <div class="text-[11px] text-slate-500 italic leading-snug border-l-2 border-slate-200 pl-2 py-0.5">
                                        ${createEditableCell(lead.Motivo_Classificacao, originalIndex, 'Motivo_Classificacao')}
                                    </div>
                                </div>
                                <div class="font-bold text-slate-800 text-sm">${createEditableCell(lead.Nome, originalIndex, 'Nome')}</div>
                                <div class="text-xs text-slate-500">${createEditableCell(lead.Empresa, originalIndex, 'Empresa')}</div>
                                <div class="mt-2 text-[10px] text-slate-400 flex flex-col gap-0.5">
                                    ${lead.telefone ? `<span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>${createEditableCell(lead.telefone, originalIndex, 'telefone')}</span>` : ''}
                                    ${lead.email ? `<span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>${createEditableCell(lead.email, originalIndex, 'email')}</span>` : ''}
                                </div>
                            </td>
                            <td class="py-4 px-5 align-top text-sm text-slate-700 leading-relaxed">
                                <div class="text-sm text-slate-700 leading-relaxed bg-slate-50 border border-slate-100 p-3 rounded-lg">
                                    <strong class="font-semibold text-slate-900 block text-[10px] uppercase tracking-wider mb-1">Evid√™ncia Encontrada:</strong>
                                    <span class="italic text-slate-600 text-xs">"${createEditableCell(lead.Evidencia_Conversa, originalIndex, 'Evidencia_Conversa')}"</span>
                                </div>
                            </td>
                        `;
                        dom.discardedTableBody.appendChild(tr);
                    });
                }

                function switchTab(tab) {
                    dom.tabQualified.classList.toggle('active', tab === 'qualified');
                    dom.tabDiscarded.classList.toggle('active', tab === 'discarded');
                    setVisible(dom.viewQualified, tab === 'qualified');
                    setVisible(dom.viewDiscarded, tab === 'discarded');
                }

                function renderUsersList() {
                    dom.usersList.textContent = '';
                    const frag = document.createDocumentFragment();

                    State.users.forEach((acc, index) => {
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between bg-white border border-slate-200 px-4 py-2.5 rounded-lg shadow-sm';

                        const left = document.createElement('span');
                        left.className = 'text-sm font-semibold text-slate-700 flex items-center gap-2';

                        left.innerHTML = `<svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7-7h14a7 7 0 00-7-7z"/></svg>`;
                        const name = document.createElement('span');
                        name.textContent = acc.user;
                        left.appendChild(name);

                        const btn = document.createElement('button');
                        btn.className = 'text-red-500 hover:bg-red-50 p-1.5 rounded transition-colors';
                        btn.title = 'Excluir Usu√°rio';
                        btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>`;
                        btn.addEventListener('click', () => Actions.removeUser(index));

                        row.appendChild(left);
                        row.appendChild(btn);
                        frag.appendChild(row);
                    });

                    dom.usersList.appendChild(frag);
                }

                function renderLogs() {
                    const h = State.history || [];
                    dom.logsContent.textContent = '';

                    if (!h.length) {
                        const wrap = document.createElement('div');
                        wrap.className = 'text-center py-12';
                        const p = document.createElement('p');
                        p.className = 'text-slate-500 font-medium';
                        p.textContent = 'Nenhum log anterior encontrado.';
                        wrap.appendChild(p);
                        dom.logsContent.appendChild(wrap);
                        return;
                    }

                    const frag = document.createDocumentFragment();

                    h.forEach((log, index) => {
                        const card = document.createElement('div');
                        card.className = 'bg-slate-50 border border-slate-200 rounded-xl p-5 mb-4 flex justify-between items-center transition-all';

                        const left = document.createElement('div');
                        const file = document.createElement('p');
                        file.className = 'font-bold text-slate-800 text-sm';
                        file.textContent = log.file;

                        const date = document.createElement('p');
                        date.className = 'text-xs text-slate-500 mt-0.5';
                        date.textContent = `Processado em: ${log.date}`;

                        left.appendChild(file);
                        left.appendChild(date);

                        const right = document.createElement('div');
                        right.className = 'flex items-center gap-4';

                        const stats = document.createElement('div');
                        stats.className = 'flex gap-4 text-center';
                        stats.innerHTML = `
              <div><p class="text-[10px] font-bold text-slate-400">Total</p><p class="font-bold text-slate-700">${log.total}</p></div>
              <div><p class="text-[10px] font-bold text-emerald-600">Qualif.</p><p class="font-bold text-emerald-700">${log.qual}</p></div>
              <div><p class="text-[10px] font-bold text-red-500">Descart.</p><p class="font-bold text-red-600">${log.disc}</p></div>
            `;

                        const del = document.createElement('button');
                        del.className = 'text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors';
                        del.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>`;
                        del.addEventListener('click', () => Actions.deleteLog(index));

                        right.appendChild(stats);
                        right.appendChild(del);

                        card.appendChild(left);
                        card.appendChild(right);

                        frag.appendChild(card);
                    });

                    dom.logsContent.appendChild(frag);
                }

                function renderContextView() {
                    const prod = Storage.getText(CONFIG.STORAGE_KEY_PROD, '');
                    const comp = Storage.getText(CONFIG.STORAGE_KEY_COMP, '');
                    const pain = Storage.getText(CONFIG.STORAGE_KEY_PAIN, '');

                    if (prod || comp || pain) {
                        dom.inputProductContext.value = prod;
                        dom.inputCompetitorContext.value = comp;
                        dom.inputPainContext.value = pain;

                        dom.viewProductContext.textContent = prod || 'N√£o especificado';
                        dom.viewCompetitorContext.textContent = comp || 'N√£o especificado';
                        dom.viewPainContext.textContent = pain || 'N√£o especificado';

                        setVisible(dom.contextEditMode, false);
                        setVisible(dom.contextViewMode, true);
                    } else {
                        setVisible(dom.contextEditMode, true);
                        setVisible(dom.contextViewMode, false);
                    }
                }

                function enableContextEdit() {
                    setVisible(dom.contextEditMode, true);
                    setVisible(dom.contextViewMode, false);
                }

                return {
                    switchPage,
                    setActiveNav,
                    resetUpload,
                    updateStats,
                    setProgress,
                    renderTables,
                    switchTab,
                    renderUsersList,
                    renderLogs,
                    setVisible,
                    clearAllData,
                    handleEdit,
                    renderContextView,
                    enableContextEdit
                };
            })();
            
            window.updateLeadData = UI.handleEdit;

            const Actions = (() => {

                function addUser() {
                    const u = (dom.newUsername.value || '').trim();
                    const p = (dom.newPassword.value || '').trim();
                    if (!u || !p) return Toast.show('Preencha usu√°rio e senha.', 'error');
                    if (State.users.some(x => x.user === u)) return Toast.show('Usu√°rio j√° existe.', 'error');

                    State.users.push({ user: u, pass: p });
                    dom.newUsername.value = '';
                    dom.newPassword.value = '';
                    UI.renderUsersList();
                    Toast.show('Usu√°rio adicionado.', 'success');
                }

                function removeUser(index) {
                    if (State.users.length <= 1) return Toast.show('Acesso negado: mantenha pelo menos 1 usu√°rio.', 'error');

                    const userToDelete = State.users[index]?.user;
                    State.users.splice(index, 1);

                    if (userToDelete && userToDelete === State.currentUser) {
                        alert('Voc√™ excluiu o usu√°rio ativo. A sess√£o ser√° encerrada.');
                        logout();
                        return;
                    }

                    UI.renderUsersList();
                }

                function login() {
                    const u = (dom.loginUser.value || '').trim();
                    const p = (dom.loginPass.value || '').trim();

                    const ok = State.users.find(acc => acc.user === u && acc.pass === p);
                    if (!ok) {
                        dom.loginError.classList.remove('hidden');
                        return;
                    }

                    State.currentUser = u;
                    dom.loggedUserName.textContent = u;
                    dom.loggedUserAvatar.textContent = u.substring(0, 2).toUpperCase();

                    dom.loginError.classList.add('hidden');
                    UI.setVisible(dom.loginScreen, false);
                    UI.setVisible(dom.appContainer, true);

                    dom.loginUser.value = '';
                    dom.loginPass.value = '';

                    UI.renderUsersList();
                    UI.switchPage('mineracao');
                    
                    if(State.data.leads && State.data.leads.length > 0) {
                        State.totalProcessingLength = State.data.leads.length;
                        UI.updateStats();
                        UI.renderTables();
                    }
                }

                function logout() {
                    State.currentUser = null;
                    UI.setVisible(dom.appContainer, false);
                    UI.setVisible(dom.loginScreen, true);
                    UI.switchPage('mineracao');
                }

                function onFileSelected(file) {
                    if (!file) return;

                    State.selectedFile = file;
                    UI.setVisible(dom.uploadPrompt, false);
                    UI.setVisible(dom.fileInfo, true);
                    dom.fileName.textContent = file.name;
                }

                async function readFileAsText(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result || '');
                        reader.onerror = () => reject(new Error('Falha ao ler arquivo.'));
                        reader.readAsText(file);
                    });
                }

                function mapRowsToLeads(rows) {
                    const pick = (r, keys) => {
                        for (const k of keys) {
                            if (r[k] != null && String(r[k]).trim() !== '') return String(r[k]).trim();
                        }
                        return '';
                    };

                    return rows.map(r => {
                        const email = pick(r, ['EMAIL', 'Email', 'e-mail', 'E-mail']);
                        const empresa = email.includes('@') ? email.split('@')[1] : pick(r, ['Empresa', 'EMPRESA', 'company', 'Company']) || 'N√£o informada';

                        const mensagens = pick(r, ['MENSAGENS', 'Mensagens', 'Resumo da Conversa', 'RESUMO', 'mensagens', 'mensagem']);
                        return {
                            lead_id: pick(r, ['CONTATO_ID', 'Lead_ID', 'LEAD_ID', 'ID', 'id']),
                            nome: pick(r, ['NOME', 'Nome', 'Contato', 'CONTATO']) || 'N/A',
                            telefone: pick(r, ['TELEFONE', 'Telefone', 'CELULAR', 'WHATSAPP', 'telefone', 'celular', 'whatsapp']) || '',
                            email: email || '',
                            empresa,
                            mensagens: mensagens || ''
                        };
                    }).filter(x => (x.mensagens || '').length > 5);
                }

                function chunk(list, size) {
                    const out = [];
                    for (let i = 0; i < list.length; i += size) out.push(list.slice(i, i + size));
                    return out;
                }

                function nowPtBr() {
                    return new Date().toLocaleString('pt-BR');
                }

                function saveHistory() {
                    Storage.set(CONFIG.STORAGE_KEY_LOGS, State.history);
                }

                function deleteLog(index) {
                    State.history.splice(index, 1);
                    saveHistory();
                    UI.renderLogs();
                }
                
                function saveContext() {
                    const prod = dom.inputProductContext.value;
                    const comp = dom.inputCompetitorContext.value;
                    const pain = dom.inputPainContext.value;

                    Storage.setText(CONFIG.STORAGE_KEY_PROD, prod);
                    Storage.setText(CONFIG.STORAGE_KEY_COMP, comp);
                    Storage.setText(CONFIG.STORAGE_KEY_PAIN, pain);
                    
                    UI.renderContextView();
                    Toast.show('Contexto de neg√≥cio atualizado com sucesso.', 'success');
                }
                
                function saveApiKey() {
                    const key = dom.inputApiKey.value.trim();
                    Storage.setText(CONFIG.STORAGE_KEY_API, key);
                    Toast.show('Chave de API salva com sucesso.', 'success');
                }

                async function startProcessing() {
                    if (!State.selectedFile) return Toast.show('Anexe o arquivo CSV primeiro.', 'error');
                    
                    State.data.leads = [];
                    Storage.set(CONFIG.STORAGE_KEY_DATA, []);
                    UI.updateStats();
                    UI.renderTables();

                    State.isProcessing = true;
                    dom.processBtn.disabled = true;
                    dom.clearDataBtn.disabled = true;
                    UI.setVisible(dom.progressArea, true);
                    UI.setProgress(0, 'Lendo arquivo e avaliando filtros autom√°ticos...');

                    try {
                        const text = await readFileAsText(State.selectedFile);
                        const rows = CSV.parse(text);

                        if (!rows.length) {
                            return Toast.show('Arquivo vazio ou formato n√£o suportado. Verifique se √© um CSV v√°lido.', 'error');
                        }

                        const cleanLeads = mapRowsToLeads(rows);
                        if (!cleanLeads.length) {
                            return Toast.show('Nenhuma linha com hist√≥rico de conversas foi encontrada.', 'error');
                        }
                        
                        State.totalProcessingLength = cleanLeads.length;
                        
                        const hasInTagInFile = cleanLeads.some(l => l.mensagens.toUpperCase().includes('[IN]'));
                        
                        const leadsToProcess = [];
                        const autoColdLeads = [];

                        cleanLeads.forEach(lead => {
                            const originalMsg = lead.mensagens || '';
                            const msg = originalMsg.toUpperCase();
                            let replied = false;
                            
                            if (hasInTagInFile) {
                                replied = msg.includes('[IN]');
                            } else {
                                replied = msg.length > 50 && msg.split('\n').length > 1; 
                            }
                            
                            if (originalMsg.length > 3000) {
                                lead.mensagens = originalMsg.slice(-3000);
                            }

                            if (replied) {
                                leadsToProcess.push(lead);
                            } else {
                                autoColdLeads.push({
                                    Lead_ID: lead.lead_id,
                                    Temperatura: 'üö´ Descartado',
                                    Motivo_Classificacao: 'Descartado automaticamente por aus√™ncia de resposta ou intera√ß√£o com o vendedor.',
                                    Evidencia_Conversa: 'Sem intera√ß√£o/retorno do prospect.',
                                    Timing_Identificado: '-',
                                    Acao_Recomendada: 'Descartado automaticamente (Sem resposta).',
                                    Score_Potencial: 0,
                                    Nome: lead.nome,
                                    Empresa: lead.empresa,
                                    telefone: lead.telefone,
                                    email: lead.email
                                });
                            }
                        });

                        if (!State.data.leads) State.data.leads = [];
                        
                        State.data.leads.push(...autoColdLeads);
                        State.data.leads.sort((a, b) => (Number(b.Score_Potencial) || 0) - (Number(a.Score_Potencial) || 0));
                        Storage.set(CONFIG.STORAGE_KEY_DATA, State.data.leads);
                        UI.updateStats();
                        UI.renderTables();

                        if (autoColdLeads.length > 0) {
                            Toast.show(`${autoColdLeads.length} leads sem resposta descartados automaticamente.`, 'info');
                        }

                        if (leadsToProcess.length === 0) {
                            UI.setProgress(100, 'Processamento finalizado (Todos descartados sem intera√ß√£o).');
                            const hasQualified = State.data.leads.some(l => !l.Temperatura.includes('Descartado'));
                            if (!hasQualified) { UI.switchTab('discarded'); }
                            return;
                        }

                        const batches = chunk(leadsToProcess, CONFIG.BATCH_SIZE);

                        let processed = 0;
                        const totalToProcess = leadsToProcess.length;

                        const results = await Concurrency.pool(
                            batches,
                            CONFIG.CONCURRENCY,
                            async (batch) => {
                                const res = await Gemini.call(batch);
                                
                                if (res && Array.isArray(res.leads)) {
                                    State.data.leads.push(...res.leads);
                                    State.data.leads.sort((a, b) => (Number(b.Score_Potencial) || 0) - (Number(a.Score_Potencial) || 0));
                                    Storage.set(CONFIG.STORAGE_KEY_DATA, State.data.leads);
                                    
                                    UI.updateStats();
                                    UI.renderTables();
                                }
                                
                                return res;
                            },
                            (doneBatches, totalBatches) => {
                                processed = Math.min(totalToProcess, doneBatches * CONFIG.BATCH_SIZE);
                                const overallProcessed = autoColdLeads.length + processed;
                                const percent = Math.round((overallProcessed / State.totalProcessingLength) * 100);

                                UI.setProgress(percent, `Avaliando leads ativos na IA... ${processed} de ${totalToProcess} conclu√≠dos.`);
                            }
                        );

                        UI.setProgress(100, 'Processamento finalizado.');

                        State.history.unshift({
                            file: State.selectedFile.name,
                            date: nowPtBr(),
                            total: cleanLeads.length,
                            qual: State.data.leads.filter(l => !(l.Temperatura || '').includes('Descartado')).length,
                            disc: State.data.leads.filter(l => (l.Temperatura || '').includes('Descartado')).length
                        });
                        saveHistory();
                        
                        const hasQualifiedFinal = State.data.leads.some(l => !l.Temperatura.includes('Descartado'));
                        if (!hasQualifiedFinal) {
                            UI.switchTab('discarded');
                        } else {
                            UI.switchTab('qualified');
                        }

                        Toast.show('Qualifica√ß√£o de base conclu√≠da.', 'success');
                    } catch (e) {
                        console.error(e);
                        Toast.show(`Falha no processamento: ${e.message || 'erro inesperado'}`, 'error');
                        
                        const hasQualifiedError = State.data.leads.some(l => !l.Temperatura.includes('Descartado'));
                        if (!hasQualifiedError) {
                            UI.switchTab('discarded');
                        }
                        
                    } finally {
                        State.isProcessing = false;
                        dom.processBtn.disabled = false;
                        dom.clearDataBtn.disabled = false;
                        UI.resetUpload();
                    }
                }

                function exportToExcel() {
                    const mapping = State.data.leads.map(l => ({
                        "Temperatura": l.Temperatura || "",
                        "Motivo Principal": l.Motivo_Classificacao || "",
                        "Evid√™ncia Extra√≠da": l.Evidencia_Conversa || "",
                        "Score de Potencial": l.Score_Potencial || 0,
                        "Timing Identificado": l.Timing_Identificado || "",
                        "A√ß√£o Recomendada": l.Acao_Recomendada || "",
                        "Nome": l.Nome || "",
                        "Empresa": l.Empresa || "",
                        "Telefone": l.telefone || "",
                        "E-mail": l.email || ""
                    }));

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(mapping);
                    ws['!cols'] = [
                        { wch: 20 }, { wch: 50 }, { wch: 60 }, { wch: 18 }, { wch: 25 }, { wch: 40 },
                        { wch: 25 }, { wch: 30 }, { wch: 20 }, { wch: 35 }
                    ];

                    XLSX.utils.book_append_sheet(wb, ws, "Diagn√≥stico Estrat√©gico");
                    XLSX.writeFile(wb, "Leads_Inteligencia_Estrategica.xlsx");
                }

                return {
                    addUser,
                    removeUser,
                    login,
                    logout,
                    onFileSelected,
                    startProcessing,
                    exportToExcel,
                    deleteLog,
                    saveContext,
                    saveApiKey
                };
            })();

            function bindEvents() {
                const toggleSidebar = () => {
                    const isHidden = dom.mainSidebar.classList.contains('hidden');
                    if (isHidden) {
                        dom.mainSidebar.classList.remove('hidden');
                        dom.mainSidebar.classList.add('flex');
                    } else {
                        dom.mainSidebar.classList.add('hidden');
                        dom.mainSidebar.classList.remove('flex');
                    }
                };

                dom.mobileMenuBtn.addEventListener('click', toggleSidebar);
                dom.closeSidebarBtn.addEventListener('click', toggleSidebar);

                const closeSidebarOnMobile = () => {
                    if (window.innerWidth < 768) {
                        dom.mainSidebar.classList.add('hidden');
                        dom.mainSidebar.classList.remove('flex');
                    }
                };

                dom.loginBtn.addEventListener('click', Actions.login);

                dom.logoutBtn.addEventListener('click', Actions.logout);

                dom.navMineracao.addEventListener('click', () => {
                    UI.setActiveNav(dom.navMineracao);
                    UI.switchPage('mineracao');
                    closeSidebarOnMobile();
                });
                dom.navLogs.addEventListener('click', () => {
                    UI.setActiveNav(dom.navLogs);
                    UI.switchPage('logs');
                    closeSidebarOnMobile();
                });
                dom.navConfig.addEventListener('click', () => {
                    UI.setActiveNav(dom.navConfig);
                    UI.switchPage('config');
                    closeSidebarOnMobile();
                });

                dom.addUserBtn.addEventListener('click', Actions.addUser);
                dom.saveContextBtn.addEventListener('click', Actions.saveContext);
                dom.editContextBtn.addEventListener('click', UI.enableContextEdit);
                dom.saveApiKeyBtn.addEventListener('click', Actions.saveApiKey);

                dom.dropZone.addEventListener('click', () => dom.fileInput.click());
                dom.fileInput.addEventListener('change', (e) => Actions.onFileSelected(e.target.files?.[0]));
                
                dom.removeFileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    UI.resetUpload();
                });

                dom.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dom.dropZone.classList.add('dragover'); });
                dom.dropZone.addEventListener('dragleave', () => dom.dropZone.classList.remove('dragover'));
                dom.dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dom.dropZone.classList.remove('dragover');
                    Actions.onFileSelected(e.dataTransfer.files?.[0]);
                });

                dom.processBtn.addEventListener('click', Actions.startProcessing);
                dom.clearDataBtn.addEventListener('click', UI.clearAllData);
                dom.exportBtn.addEventListener('click', Actions.exportToExcel);

                dom.tabQualified.addEventListener('click', () => UI.switchTab('qualified'));
                dom.tabDiscarded.addEventListener('click', () => UI.switchTab('discarded'));
            }

            function init() {
                bindEvents();
                
                dom.inputApiKey.value = Storage.getText(CONFIG.STORAGE_KEY_API, '');
                UI.renderContextView();

                UI.renderUsersList();
                UI.switchTab('qualified');
                
                if(State.data.leads && State.data.leads.length > 0) {
                    State.totalProcessingLength = State.data.leads.length;
                    State.data.leads.sort((a, b) => (Number(b.Score_Potencial) || 0) - (Number(a.Score_Potencial) || 0));
                    UI.updateStats();
                    UI.renderTables();
                }
            }

            init();
        })();
    </script>
</body>
</html>
